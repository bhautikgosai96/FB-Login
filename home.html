<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ngStorage/0.3.6/ngStorage.min.js"></script>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <title>Title</title>
</head>
<body ng-app="fbApp">

<div ng-controller="fbCtrl" ng-init="init()">
    <h3>welcome {{profileName}}</h3>
   <!-- <div ng-repeat="x in albumnList" ng-if="x.photo_count > 0">
        <h4 >{{x.name }}</h4>
        <h4 > Total images : {{x.photo_count}}</h4>
        <img ng-src ="{{ x.picture.url }}" width="50%" height="100%" class="img-responsive" style="min-height:252px; max-height:252px;"/>
    </div>-->
    <div class="w3-container">
        <div class="row" style="padding-right: 10%;">
            <div class="col-md-offset-1 col-md-3" ng-repeat="x in albumnList" ng-if="x.photo_count > 0">
                <div class=" w3-card-4" style="height: 375px;">
                    <img ng-src ="{{ x.picture.url }}" style="width:100%; height:200px;">
                    <div class="w3-container">
                        <h4 >{{x.name }}</h4>
                        <h4 > Total images : {{x.photo_count}}</h4>
                        <button class="w3-button w3-white w3-border w3-border-blue" ng-click="slideShow(x.photos)">Show Full Screen</button><br>
                        <button class="w3-button w3-white w3-border w3-border-blue" ng-click="zip(x.photos)">Download</button>
                        <input type="checkbox"
                               ng-click="selectAlbumn(x)"/>Select for multiple albumn download
                    </div>
                </div>

        </div>
    </div>
</div>
    <button class="w3-button w3-white w3-border w3-border-blue" ng-click="downloadAll()">Download All Album</button>
    <button class="w3-button w3-white w3-border w3-border-blue" ng-click="downloadSelectedAll()">Download Selected Album</button>
    <a ng-show="downloadLink" href="{{downloadLink}}" download>download from here</a>
    <a ng-show="downloadAllLink" href="{{downloadAllLink}}" download>download All Album from here</a>
    <!--<button ng-show="downloadLink" class="btn btn-success btn-block" ng-click="DownloadReady()"><b>Your download link: {{ downloadLink }} </b></button>-->


<script>
    var app = angular.module('fbApp',['ngStorage']);

    app.controller('fbCtrl',function($scope,$http,$localStorage,$window){
        $scope.init= function(){
            $scope.profileName = null;
            $scope.albumnList = [];
            $http.get('home.php')
                    .then(function(response){
                        //alert('Called');
                        //console.log("hi");
                        $scope.data = response.data;
                        $scope.profileName = $scope.data[0];
                        var i;

                        for(i=1;i<$scope.data.length;i++){
                            $scope.albumnList.push($scope.data[i]);
                        }
                        //$scope.photo = response.data;
                        //$scope.photo = $scope.photo.slice(1,-1);
                        console.log(response);
                        console.log($scope.profileName);
                        console.log($scope.albumnList);
                        //console.log($scope.photo);
                    });

        };

        $scope.slideShow = function(photo){
            $localStorage.gallery = photo;
            $window.open('slideShow.html');
        };

        $scope.DownloadReady =function(){

            $window.open($scope.downloadLink);
        };

        $scope.selectedAlbumnList = [];
       $scope.selectAlbumn = function(item){
        var i;
           var flag = false;
           if($scope.selectedAlbumnList.length==0){
               $scope.selectedAlbumnList.push(item);
           }else{
               for(i=0;i<$scope.selectedAlbumnList.length;i++){
                   if(item==$scope.selectedAlbumnList[i]){
                       flag = true;
                       return;
                   }else{
                       flag = false;
                   }
               }

               if(flag){
                   $scope.selectedAlbumnList.pop(item);
               }else{
                   $scope.selectedAlbumnList.push(item);
               }
           }

       };


        $scope.downloadSelectedAll = function(){
          console.log("selected list: "+$scope.selectedAlbumnList);
        };

        $scope.downloadAll = function(){

            console.log($scope.albumnList);
            var lst = $scope.albumnList;
            var len = lst.length;

            if(len<=0){
                alert("There is no album.");
                return;
            };

            var allAlbumnList = [];

            var i;
            for(i=0;i<len;i++){
                var albumnData = {
                    albumnName:'',
                    image:[]
                };
                var albumn = lst[i];
                albumnData.albumnName = albumn.name;

                var j;
                console.log(allAlbumnList);
                var albumnPhoto = albumn.photos;

                    for (j = 0; j < albumnPhoto.length; j++) {

                        albumnData.image.push(albumnPhoto[j].images[1].source);
                    }
                    console.log(albumnData);
                    allAlbumnList.push(albumnData);
                    console.log(allAlbumnList);
            }



            $http({
                method : "POST",
                url: 'downloadAllAlbum.php',
                data: allAlbumnList,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            }).then(function mySuccess(data) {
                console.log(data);
                console.log(data.data);
                console.log("success");
                var base_url = window.location.origin;
                var str = data.data.slice(1,-1);
                alert('Find download link at bottom of page. \nInfo:This site uses Pop-up windows. \nPlease disable any Pop-up blocker');
                $scope.downloadAllLink= base_url+'/'+str;
                console.log(base_url);
                console.log($scope.downloadAllLink);

            }, function myError(response) {
                console.log(response);
                console.log("error");
            });
        };
        $scope.zip = function(files){
            var image = [];
            for(i=0;i<files.length;i++)
            {
                image.push( files[i].images[1].source);

            }
            console.log(image);
            $http({
                method : "POST",
                url: 'zip.php',
                data: image,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            }).then(function mySuccess(data) {
                console.log(data);
                console.log(data.data);
                var str = data.data.substr(1,9);
                console.log(str);
                var base_url = window.location.origin;
                alert('Find download link at bottom of page. \nInfo:This site uses Pop-up windows. \nPlease disable any Pop-up blocker');
                $scope.downloadLink= base_url+'/'+str;
                console.log(base_url);

            }, function myError(response) {
                console.log(response);
                console.log("error");
            });
        };
    });
</script>
</body>
</html>